<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Signal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 50px;
            text-align: center;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        .send-btn {
            background: #007bff;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
        }
        .permission-status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 5px;
        }
        .granted { background: #d4edda; color: #155724; }
        .denied { background: #f8d7da; color: #721c24; }
        .default { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>üîî Trading Signal</h1>
    
    <div id="permissionStatus" class="permission-status"></div>
    
    <button onclick="connectNotifications()">
        üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    </button>
    
    <br>
    
    <button class="send-btn" onclick="sendMessage()">
        üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    </button>
    
    <button class="send-btn" onclick="sendTradingSignal()">
        üéØ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª
    </button>
    
    <div id="status"></div>

    <script>
        const SERVER_URLS = [
            'http://localhost:5000',
            'http://192.168.0.114:5000'
        ];
        let workingUrl = null;
        let myDeviceKey = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        function updatePermissionStatus() {
            const statusDiv = document.getElementById('permissionStatus');
            
            if (!("Notification" in window)) {
                statusDiv.innerHTML = "‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è";
                statusDiv.className = "permission-status denied";
                return;
            }
            
            switch(Notification.permission) {
                case "granted":
                    statusDiv.innerHTML = "‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ";
                    statusDiv.className = "permission-status granted";
                    break;
                case "denied":
                    statusDiv.innerHTML = "‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞";
                    statusDiv.className = "permission-status denied";
                    break;
                case "default":
                    statusDiv.innerHTML = "‚è≥ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –µ—â–µ –Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω–æ";
                    statusDiv.className = "permission-status default";
                    break;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∏–º –∫–∞–∫–æ–π URL —Ä–∞–±–æ—Ç–∞–µ—Ç
        async function findWorkingServer() {
            for (const url of SERVER_URLS) {
                try {
                    const response = await fetch(url + '/api/subscribe');
                    if (response.ok) {
                        workingUrl = url;
                        console.log('‚úÖ –†–∞–±–æ—á–∏–π —Å–µ—Ä–≤–µ—Ä:', url);
                        document.getElementById('status').innerHTML = 
                            "‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω! –ú–æ–∂–µ—Ç–µ –ø–æ–¥–∫–ª—é—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.";
                        return true;
                    }
                } catch (error) {
                    console.log('‚ùå –ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω:', url);
                }
            }
            document.getElementById('status').innerHTML = 
                "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: python app.py";
            return false;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, { body: body });
                return true;
            }
            return false;
        }

        async function connectNotifications() {
            if (!workingUrl) {
                document.getElementById('status').innerHTML = 
                    "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...";
                return;
            }

            const button = document.querySelector('button');
            const status = document.getElementById('status');
            
            if (!("Notification" in window)) {
                status.innerHTML = "‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è";
                return;
            }
            
            // –ï—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É–∂–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            if (Notification.permission === "denied") {
                status.innerHTML = "‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞";
                return;
            }
            
            try {
                button.disabled = true;
                button.textContent = "–ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ...";
                
                // –í–ê–ñ–ù–û: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                const permission = await Notification.requestPermission();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                updatePermissionStatus();
                
                if (permission === "granted") {
                    button.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è—é –∫–ª—é—á...";
                    
                    myDeviceKey = 'key_' + Date.now();
                    
                    const success = await sendKeyToServer(myDeviceKey);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification("‚úÖ –£—Å–ø–µ—Ö!", "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã! –í–∞—à –∫–ª—é—á: " + myDeviceKey);
                    
                    status.innerHTML = "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã! –í–∞—à –∫–ª—é—á: " + myDeviceKey;
                    button.textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ";
                    
                } else {
                    status.innerHTML = "‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ";
                    button.disabled = false;
                    button.textContent = "üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è";
                }
                
            } catch (error) {
                status.innerHTML = "‚ùå –û—à–∏–±–∫–∞: " + error.message;
                button.disabled = false;
                button.textContent = "üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è";
            }
        }

        async function sendKeyToServer(key) {
            try {
                const response = await fetch(workingUrl + '/api/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        device_key: key
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ –ö–ª—é—á –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:', key);
                    return true;
                } else {
                    throw new Error('HTTP ' + response.status);
                }
                
            } catch (error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error.message);
                return false;
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            if (!workingUrl) {
                alert("–°–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω");
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
            if (Notification.permission !== "granted") {
                alert("–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è!");
                return;
            }

            try {
                const response = await fetch(workingUrl + '/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: "üì¢ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!"
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('status').innerHTML = 
                        `‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: ${result.total_recipients}`;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification("üì¢ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!", "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
                    
                    console.log("–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:", result.recipients);
                }
            } catch (error) {
                document.getElementById('status').innerHTML = 
                    "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + error.message;
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
        async function sendTradingSignal() {
            if (!workingUrl) {
                alert("–°–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω");
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
            if (Notification.permission !== "granted") {
                alert("–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è!");
                return;
            }

            try {
                const response = await fetch(workingUrl + '/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: "üéØ –¢–û–†–ì–û–í–´–ô –°–ò–ì–ù–ê–õ: BTC/USDT - –û—Ä–¥–µ—Ä-–±–ª–æ–∫ $42,500-$42,800"
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('status').innerHTML = 
                        `‚úÖ –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: ${result.total_recipients}`;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification("üéØ –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª!", "BTC/USDT - –û—Ä–¥–µ—Ä-–±–ª–æ–∫ $42,500-$42,800");
                }
            } catch (error) {
                document.getElementById('status').innerHTML = 
                    "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + error.message;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            updatePermissionStatus();
            findWorkingServer();
        });
    </script>
</body>
</html>
