<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Signal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 50px;
            text-align: center;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 20px 40px;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>üîî Trading Signal</h1>
    
    <button onclick="connectNotifications()">
        üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    </button>
    
    <div id="status"></div>

    <script>
        const SERVER_URL = 'http://192.168.0.114:5000';

        async function connectNotifications() {
            const button = document.querySelector('button');
            const status = document.getElementById('status');
            
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            if (!("Notification" in window)) {
                status.innerHTML = "‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è";
                return;
            }
            
            try {
                button.disabled = true;
                button.textContent = "–ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ...";
                
                // 2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                const permission = await Notification.requestPermission();
                
                if (permission === "granted") {
                    button.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è—é –∫–ª—é—á...";
                    
                    // 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á
                    const deviceKey = 'key_' + Date.now();
                    
                    // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    await sendKeyToServer(deviceKey);
                    
                    // 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    new Notification("‚úÖ –£—Å–ø–µ—Ö!", {
                        body: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã! –ö–ª—é—á: " + deviceKey
                    });
                    
                    status.innerHTML = "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã! –ö–ª—é—á –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.";
                    button.textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ";
                    
                } else {
                    status.innerHTML = "‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ";
                    button.disabled = false;
                    button.textContent = "üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è";
                }
                
            } catch (error) {
                status.innerHTML = "‚ùå –û—à–∏–±–∫–∞: " + error.message;
                button.disabled = false;
                button.textContent = "üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è";
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function sendKeyToServer(key) {
            try {
                const response = await fetch(SERVER_URL + '/api/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        device_key: key,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª');
                }

                console.log('‚úÖ –ö–ª—é—á –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:', key);
                
            } catch (error) {
                console.log('‚ö†Ô∏è –ö–ª—é—á –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç');
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç
            }
        }
    </script>
</body>
</html>
