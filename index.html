<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Signal - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            width: 100%;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .hidden {
            display: none;
        }
        .debug {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Trading Signal</h1>
        <p>–ü—Ä–æ—Å—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
        
        <button id="connectButton" onclick="connectNotifications()">
            üîî –ü–æ–¥–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </button>
        
        <div id="status" class="status hidden"></div>

        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
            <button onclick="sendTestNotification()" style="background: #007bff;">
                üìß –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            </button>
            <button onclick="sendTradingNotification()" style="background: #ff6b00;">
                üéØ –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª
            </button>
            <button onclick="checkServer()" style="background: #6c757d;">
                üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
            </button>
        </div>

        <div class="debug">
            <strong>–õ–æ–≥ –æ—Ç–ª–∞–¥–∫–∏:</strong>
            <div id="debug"></div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'http://192.168.0.114:5000';

        function debugLog(message) {
            const debugDiv = document.getElementById('debug');
            debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(message);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function clearStatus() {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = '';
            statusDiv.className = 'status hidden';
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function checkNotificationSupport() {
            if (!("Notification" in window)) {
                return { supported: false, message: "–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" };
            }
            return { supported: true, message: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è" };
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function connectNotifications() {
            const button = document.getElementById('connectButton');
            
            debugLog('=== –ù–ê–ß–ê–õ–û –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ===');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
            const support = checkNotificationSupport();
            if (!support.supported) {
                showStatus('‚ùå ' + support.message, 'error');
                return;
            }
            debugLog('‚úÖ ' + support.message);

            try {
                button.disabled = true;
                button.textContent = '–ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ...';
                clearStatus();

                debugLog('1. –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...');

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                const permission = await Notification.requestPermission();
                debugLog(`2. –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞: ${permission}`);

                if (permission === "granted") {
                    debugLog('‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ!');

                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                    const deviceKey = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                    debugLog(`3. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–ª—é—á: ${deviceKey}`);

                    button.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é –∫–ª—é—á...';

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    try {
                        await saveDeviceKey(deviceKey);
                        debugLog('‚úÖ –ö–ª—é—á –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
                    } catch (error) {
                        debugLog(`‚ö†Ô∏è –ö–ª—é—á –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ${error.message}`);
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification("‚úÖ –£—Å–ø–µ—Ö!", "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã! –¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã.");
                    debugLog('4. –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ');

                    showStatus('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã!', 'success');
                    button.textContent = '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã';
                    button.disabled = true;
                    button.style.background = '#28a745';

                    debugLog('=== –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –£–°–ü–ï–®–ù–û ===');

                } else {
                    const errorMsg = "‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ";
                    debugLog(errorMsg);
                    showStatus(errorMsg, 'error');
                    button.disabled = false;
                    button.textContent = 'üîî –ü–æ–¥–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
                }

            } catch (error) {
                const errorMsg = "‚ùå –û—à–∏–±–∫–∞: " + error.message;
                debugLog(errorMsg);
                showStatus(errorMsg, 'error');
                button.disabled = false;
                button.textContent = 'üîî –ü–æ–¥–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(title, body) {
            if (Notification.permission === "granted") {
                try {
                    new Notification(title, { 
                        body: body,
                        // –ë–µ–∑ –∏–∫–æ–Ω–æ–∫ —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ–∫
                        tag: 'trading-signal'
                    });
                    return true;
                } catch (error) {
                    debugLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${error.message}`);
                    return false;
                }
            }
            return false;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function saveDeviceKey(deviceKey) {
            try {
                const response = await fetch(SERVER_URL + '/api/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        device_key: deviceKey,
                        type: 'browser_notification',
                        user_agent: navigator.userAgent,
                        timestamp: new Date().toISOString(),
                        screen: `${screen.width}x${screen.height}`,
                        platform: navigator.platform
                    })
                });

                debugLog(`–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                debugLog(`–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(result)}`);
                return result;

            } catch (error) {
                debugLog(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª—é—á–∞: ${error.message}`);
                throw error;
            }
        }

        // –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function sendTestNotification() {
            debugLog('--- –¢–ï–°–¢–û–í–û–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ï ---');
            
            if (Notification.permission !== "granted") {
                showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
                return;
            }

            const success = showNotification("üìä –¢–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª", "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π!");
            if (success) {
                showStatus('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ!', 'success');
                debugLog('–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–æ');
            } else {
                showStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ', 'error');
            }
        }

        // –¢–æ—Ä–≥–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function sendTradingNotification() {
            debugLog('--- –¢–û–†–ì–û–í–´–ô –°–ò–ì–ù–ê–õ ---');
            
            if (Notification.permission !== "granted") {
                showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
                return;
            }

            const success = showNotification(
                "üéØ BTC/USDT - –û—Ä–¥–µ—Ä-–±–ª–æ–∫", 
                "–£—Ä–æ–≤–µ–Ω—å: $42,500 - $42,800\n–í—Ä–µ–º—è: " + new Date().toLocaleTimeString()
            );
            
            if (success) {
                showStatus('‚úÖ –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
                debugLog('–¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª —É—Å–ø–µ—à–Ω–æ –ø–æ–∫–∞–∑–∞–Ω');
            } else {
                showStatus('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞', 'error');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
        async function checkServer() {
            debugLog('--- –ü–†–û–í–ï–†–ö–ê –°–ï–†–í–ï–†–ê ---');
            
            try {
                const response = await fetch(SERVER_URL + '/api/debug');
                if (response.ok) {
                    const data = await response.json();
                    debugLog(`‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–¥–ø–∏—Å–æ–∫: ${data.total_subscriptions || 0}`);
                    showStatus(`‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç (${data.total_subscriptions || 0} –ø–æ–¥–ø–∏—Å–æ–∫)`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                debugLog(`‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}`);
                showStatus('‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            debugLog(`User Agent: ${navigator.userAgent}`);
            debugLog(`Platform: ${navigator.platform}`);
            debugLog(`Screen: ${screen.width}x${screen.height}`);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
            const permission = Notification.permission;
            debugLog(`–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π: ${permission}`);

            if (permission === "granted") {
                showStatus('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã', 'success');
                document.getElementById('connectButton').textContent = '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã';
                document.getElementById('connectButton').disabled = true;
                document.getElementById('connectButton').style.background = '#28a745';
            } else if (permission === "denied") {
                showStatus('‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞', 'error');
                document.getElementById('connectButton').disabled = true;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
            const support = checkNotificationSupport();
            if (!support.supported) {
                document.getElementById('connectButton').disabled = true;
                document.getElementById('connectButton').textContent = '‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            }
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(e) {
            debugLog(`üí• –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: ${e.message}`);
        });
    </script>
</body>
</html>
