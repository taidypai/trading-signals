<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Signal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 50px;
            text-align: center;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        .send-btn {
            background: #007bff;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>üîî Trading Signal</h1>
    
    <button onclick="connectNotifications()">
        üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    </button>
    
    <br>
    
    <button class="send-btn" onclick="sendMessage()">
        üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    </button>
    
    <button class="send-btn" onclick="sendTradingSignal()">
        üéØ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª
    </button>
    
    <div id="status"></div>

    <script>
        const SERVER_URLS = [
            'http://localhost:5000',
            'http://192.168.0.114:5000'
        ];
        let workingUrl = null;
        let myDeviceKey = null;

        // –ü—Ä–æ–≤–µ—Ä–∏–º –∫–∞–∫–æ–π URL —Ä–∞–±–æ—Ç–∞–µ—Ç
        async function findWorkingServer() {
            for (const url of SERVER_URLS) {
                try {
                    const response = await fetch(url + '/api/subscribe');
                    if (response.ok) {
                        workingUrl = url;
                        console.log('‚úÖ –†–∞–±–æ—á–∏–π —Å–µ—Ä–≤–µ—Ä:', url);
                        document.getElementById('status').innerHTML = 
                            "‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω! –ú–æ–∂–µ—Ç–µ –ø–æ–¥–∫–ª—é—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.";
                        return true;
                    }
                } catch (error) {
                    console.log('‚ùå –ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω:', url);
                }
            }
            document.getElementById('status').innerHTML = 
                "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: python app.py";
            return false;
        }

        // –ü—Ä–æ–≤–µ—Ä–∏–º —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        findWorkingServer();

        async function connectNotifications() {
            if (!workingUrl) {
                document.getElementById('status').innerHTML = 
                    "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...";
                return;
            }

            const button = document.querySelector('button');
            const status = document.getElementById('status');
            
            if (!("Notification" in window)) {
                status.innerHTML = "‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è";
                return;
            }
            
            try {
                button.disabled = true;
                button.textContent = "–ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ...";
                
                const permission = await Notification.requestPermission();
                
                if (permission === "granted") {
                    button.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è—é –∫–ª—é—á...";
                    
                    myDeviceKey = 'key_' + Date.now();
                    
                    const success = await sendKeyToServer(myDeviceKey);
                    
                    new Notification("‚úÖ –£—Å–ø–µ—Ö!", {
                        body: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã! –í–∞—à –∫–ª—é—á: " + myDeviceKey
                    });
                    
                    status.innerHTML = "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã! –í–∞—à –∫–ª—é—á: " + myDeviceKey;
                    button.textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ";
                    
                } else {
                    status.innerHTML = "‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ";
                    button.disabled = false;
                    button.textContent = "üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è";
                }
                
            } catch (error) {
                status.innerHTML = "‚ùå –û—à–∏–±–∫–∞: " + error.message;
                button.disabled = false;
                button.textContent = "üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è";
            }
        }

        async function sendKeyToServer(key) {
            try {
                const response = await fetch(workingUrl + '/api/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        device_key: key
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ –ö–ª—é—á –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:', key);
                    return true;
                } else {
                    throw new Error('HTTP ' + response.status);
                }
                
            } catch (error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error.message);
                return false;
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            if (!workingUrl) {
                alert("–°–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω");
                return;
            }

            try {
                const response = await fetch(workingUrl + '/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: "üì¢ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!"
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('status').innerHTML = 
                        `‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: ${result.total_recipients}`;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    if (Notification.permission === "granted") {
                        new Notification("üì¢ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!", {
                            body: "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞"
                        });
                    }
                    
                    console.log("–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:", result.recipients);
                }
            } catch (error) {
                document.getElementById('status').innerHTML = 
                    "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + error.message;
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
        async function sendTradingSignal() {
            if (!workingUrl) {
                alert("–°–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω");
                return;
            }

            try {
                const response = await fetch(workingUrl + '/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: "üéØ –¢–û–†–ì–û–í–´–ô –°–ò–ì–ù–ê–õ: BTC/USDT - –û—Ä–¥–µ—Ä-–±–ª–æ–∫ $42,500-$42,800"
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('status').innerHTML = 
                        `‚úÖ –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: ${result.total_recipients}`;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    if (Notification.permission === "granted") {
                        new Notification("üéØ –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª!", {
                            body: "BTC/USDT - –û—Ä–¥–µ—Ä-–±–ª–æ–∫ $42,500-$42,800"
                        });
                    }
                }
            } catch (error) {
                document.getElementById('status').innerHTML = 
                    "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + error.message;
            }
        }
    </script>
</body>
</html>
